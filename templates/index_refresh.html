<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>CARE</title>
   <!-- CSS  -->
  <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->

<link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/material-icons.css') }}">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/materialize.css') }}">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/style.css') }}">
    <style type="text/css">
   .btn-floating.btn-large {
  width: 100%;/*106*/
  height: 100%;/*106*/
}
ul[class^=suf_timer-] {
  line-height: 20px;
  /*border: 15px solid white;
  border-color:transparent;*/
  padding: 0;
  margin:0;
  display:none;
}
.btn-floating{
  border-radius: 0%;
}
#square {
  zoom:{{zommdata}};
}
h6[id^=caller-icon-]
{
  display:none;
  visibility: hidden;
  max-height: 0;
}

div[class^="timer-"]{
  display:none;
}
div[class^="atimer-"]{
  /*display:none;*/
  font-size: 50px;
  border: 15px solid white;
  border-color:transparent;
  
}

div[class^="switchname-"]{
  display:none;

}
h1[id^=caller-node-]{
  font-size: 100px;
  margin-bottom: 0;
  margin:0;
}
.Suffix{
  margin:0;
  font-size: 80px;
  border: 15px solid white;
  border-color:transparent;
}

.wrapper{
  display: inline-flex;  
  flex-wrap: wrap;
  /*column-gap: 40px;*/
  /*gap: 50px;*/
  flex-direction: row;
  /*justify-content: space-around;*/
  /*padding : 1rem;*/

  /*border: 1px solid black;*/
   /*display: flex;
   flex-flow: wrap;
   border-right:solid 1px white
   justify-content: space-between;
   list-style: none;
   margin: 0;*/
   /*padding: 0;*/

}


.centered{
	table-layout: fixed;
}

</style>
  </head>
<body class="white" >

<audio id="myAudio" ><source src="{{ url_for('static', filename='sound/bell.mp3') }}"type="audio/mp3"> </source></audio>

{%for a_id,afile in audFiles.items() %}
<audio id={{a_id}}><source src="{{ url_for('static', filename=afile) }}"type="audio/mp3"> </source></audio>
{%endfor%}

<!-- {%for i in range(1,48)%} 
<div class="atimer-{{i}}"></div>
{%endfor%}  -->

<div>
    <img src="{{ url_for('static', filename='images/title.png') }}" alt="Cinque Terre" width="100%"height="100%">
  </div>
 <!--  <div id="testing"> 12</div> -->
<div id="square">
     <table class="centered">
        <tbody>
            <tr>
               <td style="width:4px;"></td> <!-- this is for space !!293.8px 137.8 -->
            {%for i,aud in BxSwitches.items()%} <!-- 51 border: 1px solid rgb(169, 169, 169);-->
            <!-- {{i}} -->
            {%if(i<=actualbedcount)%} 
            <!-- <div class="timer-{{i}}"></div> -->
                    <!-- {{i}}{{actualbedcount}} -->
                    <td style="border: 3px solid rgb(0, 0, 0); width:134.8px; height:293.8px; "><div class="icon-block"><div class="row center"><a id="caller-effect-{{i}}"><h1 class="center grey-text" id="caller-node-{{i}}"><b>{{dsptxt[i]}}</b></h1><div class="wrapper">{%for ai in aud%}<ul class="suf_timer-{{ai}}"><li ><h1 class="Suffix" id="Suffix-{{ai}}"></h1><div class="atimer-{{ai}}"></div></li></ul>{%endfor%}</div><i class="material-icons"><h6 class="center" id="caller-icon-{{i}}">remove</h6></i></a></div></div></td>
                {%endif%} 
            {% if i%noofcolumn==0%} <!-- 10 -->
            {% if i==totalbed%} <!-- 50 -->
             <td style="width:4px;"></td> <!-- this is for space  -->
            </tr>
            {%else%}
             <td style="width:4px;"></td> <!-- this is for space  -->
            </tr><tr> <td style="width:4px;"></td> <!-- this is for space  -->
            {%endif%} 
            
             {%endif%} 
            
            
            {%endfor%} 

        </tbody>
      </table>
   

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js') }}"></script>
  <script src="{{url_for('static', filename='js/socket_3_1_2.io.js')}}"></script>
  <script src="{{ url_for('static', filename='js/materialize.js') }}"></script>
   <script src="{{ url_for('static', filename='js/init.js') }}"></script>
   <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ez.countimer.js') }}"></script>

  <script>


      $(document).ready(function() {
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            //var audio = $("audio")[0];
            var types = {};
            var audtypes={};
            $(this).css("background-color", "gray");

            socket.on('reload', function(data) {
              console.log("Reload Request Recieved..!!")
                  window.location.reload();
              });
            socket.on('mqtt_message', function(data) {
                console.log(data);
                var i=data['client'];
                var ai=data['clientid'];
                $('#testing').append("event main=>"+i+"=>ai=> "+ai);
                 var boxname=data['boxname'];
                 var boxSuff=data['suffix'];
                 if(data['payload']==='150')
                    {
                      // console.log("Audio Play")
                     ////Timer
                      $('.atimer-'+ai).countimer({enableEvents: true}).on('second', function(evt, time){
                      //console.log("timer",time);
                        if(time.original.seconds==30 || (time.original.minutes>0 && time.original.seconds==0)){//time
                        var xt=eval("boxbgchange_"+i);
                        xt();
                    //    $("audio")[ai].play();
                        var bus=checkaudiocurrenttime();
                        // $('#testing').append("bus[0]=>"+bus[0]);
                        // $('#testing').append(" bus[1]=>"+bus[1]);
                        if(bus[0]===1)
                            {
                              // $('#testing').append("insidebus[0]=>");
                              if( $("audio")[bus[1]].paused )
                              {
                                $("audio")[0].pause();
                                $("audio")[bus[1]].currentTime = 0;
                                $("audio")[0].unbind();
                                $("audio")[ai].currentTime = 0;
                          $("audio")[ai].loop=false;
                            $("audio")[ai].play();
                            $("audio")[ai].onended=eval("removeaudio_"+ai);
                            $("audio")[ai].currentTime = 0;
                           // console.log("AudioID:",ai)
                            
                             // $('#testing').append("insidebus[1]=>");
                              }else
                              {
                              	// console.log("AudioID:",ai)
                               $("audio")[bus[1]].onended=eval("audioplaylist_"+ai);
                             $("audio")[ai].onended=eval("removeaudio_"+ai);
                              $("audio")[ai].onended=eval("removeaudio_"+bus[1]);
                              //$('#testing').append("insidebus[1] else=>");
                              }
                        
                              
                            }else{
                            	// console.log("AudioID:",ai)
                            	$('#testing').append("event main=>"+i+"=>ai=> "+ai);
                       // $('#testing').append("insidebus[0] elseet=>"+ai);
                        $("audio")[ai].currentTime = 0;
                          $("audio")[ai].loop=false;
                            $("audio")[ai].play();
                            $("audio")[ai].onended=eval("removeaudio_"+ai);
                            $("audio")[ai].currentTime = 0;
                            checkaudiocurrenttime();
                            }
                    }
                      });
                      ////Timer
                      $('.atimer-'+ai).countimer('start')
                      document.getElementById("Suffix-"+ai).innerHTML = boxSuff;
                      // $('.atimer-'+ai).show();
                      $('.suf_timer-'+ai).show();
                      // audio.pause();
                      // audio.currentTime = 0;
                     var ght= $('#caller-icon-' + i).text();
                     var currentname=$('#caller-node-' + i).text();
                    
                      if(ght==='150'){
                        var crdata = currentname.match(/[a-zA-Z]/);
                        var indata = boxname.match(/[a-zA-Z]/);
                        // $('#testing').append(crdata+ 'SPACE');
                        // $('#testing').append(indata+ 'SPACE');
                        var n = currentname.includes(indata)
                        if(n===true)
                        {
                          }
                     else{
                        // $('#testing').append(currentname.concat(indata));
                       // $('#caller-node-' + i).text(currentname.concat(indata));
                       }
                        ///////////////////////////
                        
                        var bus=checkaudiocurrenttime();
                        // $('#testing').append("bus[0]=>"+bus[0]);
                        // $('#testing').append(" bus[1]=>"+bus[1]);
                        if(bus[0]===1)
                            {
                              // $('#testing').append("insidebus[0]=>");
                              if( $("audio")[bus[1]].paused )
                              {
                                $("audio")[0].pause();
                                $("audio")[bus[1]].currentTime = 0;
                                $("audio")[0].unbind();
                                $("audio")[ai].currentTime = 0;
                          $("audio")[ai].loop=false;
                            $("audio")[ai].play();
                            $("audio")[ai].onended=eval("removeaudio_"+ai);
                            $("audio")[ai].currentTime = 0;
                           // console.log("AudioID:",ai)
                            
                             // $('#testing').append("insidebus[1]=>");
                              }else
                              {
                              	// console.log("AudioID:",ai)
                               $("audio")[bus[1]].onended=eval("audioplaylist_"+ai);
                             $("audio")[ai].onended=eval("removeaudio_"+ai);
                              $("audio")[ai].onended=eval("removeaudio_"+bus[1]);
                              //$('#testing').append("insidebus[1] else=>");
                              }
                        
                              
                            }else{
                            	// console.log("AudioID:",ai)
                            	$('#testing').append("event main=>"+i+"=>ai=> "+ai);
                       // $('#testing').append("insidebus[0] elseet=>"+ai);
                        $("audio")[ai].currentTime = 0;
                          $("audio")[ai].loop=false;
                            $("audio")[ai].play();
                            $("audio")[ai].onended=eval("removeaudio_"+ai);
                            $("audio")[ai].currentTime = 0;
                            checkaudiocurrenttime();
                            }

                        ///////////////////////////////
                        $('#testing').append("event main=>"+ $('#caller-icon-' + i).text());

                       } 
                      else{
                      	 $('#caller-node-' + i).removeClass('center grey-text'); 
                    $('#caller-node-' + i).addClass('center');  
                    $('#caller-effect-'+i).addClass('btn-floating btn-large pulse cyan ')
                    $('#testing').append("event main=>"+ $('#caller-icon-' + i).text());
                      	$('#testing').append("event mainccc=>"+$('#caller-icon-' + i).text());
                      	
                      	$('#caller-icon-' + i).text('150');
                      //$('#caller-node-' + i).text(boxname);
                        var bus=checkaudiocurrenttime();
                        $('#testing').append("bus[0]=>"+bus[0]);
                        $('#testing').append(" bus[1]=>"+bus[1]);
                        if(bus[0]===1)
                            {
                               $('#testing').append("insidebus[0]=>");
                              if( $("audio")[bus[1]].paused )
                              {
                                $("audio")[0].pause();
                                $("audio")[bus[1]].currentTime = 0;
                                $("audio")[0].unbind();
                                $("audio")[ai].currentTime = 0;
                          $("audio")[ai].loop=false;
                            $("audio")[ai].play();
                            $("audio")[ai].onended=eval("removeaudio_"+ai);
                            $("audio")[ai].currentTime = 0;

                             // $('#testing').append("insidebus[1]=>");
                              }else
                              {
                               $("audio")[bus[1]].onended=eval("audioplaylist_"+ai);
                             $("audio")[ai].onended=eval("removeaudio_"+ai);
                              $("audio")[ai].onended=eval("removeaudio_"+bus[1]);
                             // $('#testing').append("insidebus[1] else=>");
                              }
                        
                              
                            }else{
                        $('#testing').append("insidebus[0] elseet=>"+ai);
                        $("audio")[ai].currentTime = 0;
                        $('#testing').append("1");
                          $("audio")[ai].loop=false;
                          $('#testing').append("2");
                            $("audio")[ai].play();
                            $('#testing').append("3");
                            $("audio")[ai].onended=eval("removeaudio_"+ai);
                            $('#testing').append("4");
                            $("audio")[ai].currentTime = 0;
                            $('#testing').append("5");
                            checkaudiocurrenttime();
                             $('#testing').append("6");
                            }

                         

                         //var xt=eval("boxbgchange_"+i);
                         //types["ft"+i]=setInterval(xt, 30000);

                         //$('.timer-'+i).countimer('start');
                         //$('.atimer-'+ai).countimer({enableEvents: true}).on('minute', function(evt, time){console.log("timer",time);$("audio")[ai].play();});
                  }
                    $('#caller-node-' + i).removeClass('center grey-text'); 
                    $('#caller-node-' + i).addClass('center');  
                    $('#caller-effect-'+i).addClass('btn-floating btn-large pulse cyan ')
                    // $('#testing').append("event main=>"+ $('#caller-icon-' + i).text);
                    if( $('.timer-'+i).countimer('stopped'))
                    {
                    	  

                    	 //var xt=eval("boxbgchange_"+i);
                         //types["ft"+i]=setInterval(xt, 30000);
                         //$('.timer-'+i).countimer('start');
                          // $('.timer-'+i).countimer({enableEvents: true}).on('second', function(evt, time){console.log("timer",time)});
                    }
                    $('#testing').append("event main=>"+"here") ;
                    //audio.loop=false;audio.play();
                    }
                else if(data['payload']==='180')
                    {
                    	// console.log("AudioID:",ai)
                      $('.atimer-'+ai).countimer('stop');
                      // document.getElementById("Suffix-"+ai).innerHTML = "";
                      // $('.atimer-'+ai).removeAttr("style").hide();
                      $('.suf_timer-'+ai).removeAttr("style").hide();


                      
                                            var numbers = /^[0-9]+$/;
                      var indataend = "/"+boxname.match(/[a-zA-Z]/)+"/";
                      var replacenameddata=$('#caller-node-' + i).text()
                      var replacename=replacenameddata.replace(eval(indataend), "");
                       //$('#caller-node-' + i).text(replacename)
                        replacenameddata=$('#caller-node-' + i).text()
                      //if(replacenameddata.match(numbers))
                      if(data['Effect']==false)
                      {
                        var hogt= $('#caller-icon-' + i).text();
                        if(hogt==='150'){
                        	$('#caller-effect-'+i).removeClass('cyan-red');}
                        $('#caller-icon-' + i).text('remove');
                        $('#caller-node-' + i).addClass('grey-text');
                        $('#caller-effect-'+i).removeClass('btn-floating btn-large pulse cyan ');
                        $('#caller-effect-'+i).removeClass('cyan-red');
                       clearTimeout(types["ft"+i]);
                      $("audio")[ai].pause();
                      $("audio")[ai].currentTime = 0;
                       //$('.timer-'+i).countimer('stop');
                      $("audio")[ai].unbind();
                    }
                    $('#testing').append("event main=>"+ $('#caller-icon-' + i).text());
                  }

                })
            {%for i in range(1,47+1)%}  /*51*/
            function boxbgchange_{{i}} (){ $('#caller-effect-{{i}}').removeClass('cyan'); $('#caller-effect-{{i}}').addClass('cyan-red'); 
              // $("audio")[0].play();
              //beep();
        }
             //$('.timer-{{i}}').countimer({autoStart : false});
            
            function audioplaylist_{{i}}(){
            	// console.log("AudioPlay:",{{i}})
            $("audio")[{{i}}].loop=false;
             $("audio")[{{i}}].play(); 
            // $("audio")[i].addEventListener('ended',eval(eval('removeaudio({{i}}')));
            //$("audio")[{{i}}].removeEventListener('onended',eval('removeaudio{{i}}'));
            //$("audio")[{{i}}].pause();
            $("audio")[{{i}}].currentTime = 0;
            //$("audio")[{{i}}].unbind();
   
            }
            function removeaudio_{{i}}() {

              $("audio")[{{i}}].pause();
              $("audio")[{{i}}].currentTime = 0;
              //$("audio")[{{i}}].removeEventListener('ended',eval('removeaudio{{i}}'));
              $("audio")[{{i}}].unbind();
              // body... 
            }
            {%endfor%} 
            function beep() {
              var car=checkaudiocurrenttime();
              var duck=0;
                        if(car[0]===1 )
                            {
                              if($("audio")[car[1]].paused)
                              {
                                $("audio")[0].pause();
                                $("audio")[car[1]].currentTime = 0;
                                $("audio")[0].unbind();
                                 $("audio")[duck].currentTime = 0;
                          $("audio")[duck].loop=false;
                            $("audio")[duck].play();
                            $("audio")[duck].onended=eval("removeaudio_"+duck);
                            $("audio")[duck].currentTime = 0;
                           // $('#testing').append("play beep=>");
                              }else{
                                $("audio")[car[1]].onended=eval("audioplaylist_"+duck);
                             $("audio")[duck].onended=eval("removeaudio_"+duck);
                              $("audio")[duck].onended=eval("removeaudio_"+car[1]);
                            //  $('#testing').append("event beep=>"+$("audio")[car[1]].currentTime);
                              }
                            
                              
                            }else{
                        $("audio")[duck].currentTime = 0;
                          $("audio")[duck].loop=false;
                            $("audio")[duck].play();
                            $("audio")[duck].onended=eval("removeaudio_"+duck);
                            $("audio")[duck].currentTime = 0;
                           // checkaudiocurrenttime();
                            }
            }
            function checkaudiocurrenttime()
            {
              var arr;
              for( var i=0;i<{{actualbedcount+1}};i++)
              {
                if($("audio")[i].currentTime >0)
                {
                  arr=[1,i];
                  return arr;
                }
              }
              arr=[0,-1];
              return arr;
            }
            function audioplaylist_0(){
            $("audio")[0].loop=false;
             $("audio")[0].play(); 
            $("audio")[0].currentTime = 0;
   
            }
            function removeaudio_0() { 

              $("audio")[0].pause();
              $("audio")[0].currentTime = 0;
              $("audio")[0].unbind();
}
         
      });
     
  </script>
  </body>
  </html>
